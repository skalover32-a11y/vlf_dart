# Критическое исправление: Интернет работает в TUN режиме

## Дата: 26 ноября 2025 (обновлено)

## Проблема

После миграции на Clash Meta (mihomo) обнаружилась критическая проблема:

**Симптом:** Полное отсутствие интернета при активном туннеле.

**Причины:**
1. **Неправильный TUN-блок**: использовался `stack: system` вместо `stack: gvisor`
2. **Неправильный DNS**: fake-ip режим конфликтовал с Windows TUN
3. **Неправильный MATCH**: использовалось несуществующее имя outbound
4. **Логи очищались** при переключении режимов

**Корень проблемы:** Неправильная конфигурация TUN + DNS для Windows.

## Решение

### 1. Исправлен DNS (убран fake-ip, добавлены DoH)

**Проблема:** fake-ip режим не работает корректно в Windows TUN.

**Решение:**
```yaml
dns:
  enable: true
  prefer-h3: true       # HTTP/3 для быстрого DNS
  ipv6: false
  default-nameserver:
    - 8.8.8.8
    - 1.1.1.1
  nameserver:
    - https://dns.google/dns-query      # DNS-over-HTTPS
    - https://1.1.1.1/dns-query
  fallback:
    - tls://9.9.9.9     # DNS-over-TLS для надежности
    - tls://8.8.4.4
```

**Эффект:** DNS работает через безопасные каналы (DoH/DoT) без конфликтов с TUN.

### 2. Исправлен TUN (gvisor + правильные параметры)

**Проблема:** `stack: system` не работает стабильно в Windows. Неправильный dns-hijack.

**Решение:**
```yaml
tun:
  enable: true
  stack: gvisor          # КРИТИЧНО: только gvisor работает стабильно
  auto-route: true
  auto-detect-interface: true
  dns-hijack:
    - "198.18.0.2:53"   # КРИТИЧНО: правильный адрес для gvisor
  mtu: 9000             # КРИТИЧНО: оптимальное значение для Windows
```

**Эффект:**
- `stack: gvisor` обеспечивает стабильную работу TUN в Windows
- `dns-hijack: "198.18.0.2:53"` правильно перехватывает DNS
- `mtu: 9000` оптимизирует производительность

### 3. Автоматическое имя outbound в MATCH

**Проблема:** MATCH использовал хардкод "VLF-PROXY", но реальное имя зависит от сервера.

**Решение:**
```dart
// Генерируем уникальное имя прокси на основе сервера
final proxyName = 'VLF-$server';

// Используем его в proxy-groups
proxy-groups:
  - name: "VLF"
    proxies:
      - "$proxyName"  // Автоматическое имя

// И в MATCH правиле
rules:
  - MATCH,VLF  // Всегда корректное имя
```

**Эффект:** MATCH теперь всегда указывает на существующий proxy.

### 4. Сохранение истории логов

**Проблема:** Логи не должны очищаться при переключении режимов.

**Решение:**
- Логи хранятся в `logger.history` и не очищаются автоматически
- Только кнопка "Очистить" удаляет логи
- История логов сохраняется между перезапусками туннеля и переключением режимов

## Как проверить, что теперь работает

### Проверка РФ-режима

1. **Включите РФ-режим** (переключатель "Режим РФ")
2. **Запустите VPN**
3. **Откройте https://2ip.ru** → должен показать ваш **реальный российский IP** (ISP IP, не IP VPN-сервера)
4. **Откройте https://google.com** → должен показать **IP VPN-сервера** (другая страна)

### Проверка исключений

1. **Добавьте google.com в исключения** (Настройки → Исключения → Добавить домен)
2. **Запустите VPN** (режим не важен)
3. **Откройте https://google.com** → должен показать ваш **реальный IP** (не IP VPN)
4. **Откройте https://youtube.com** → должен показать **IP VPN-сервера**

### Проверка конфигурации

Откройте `config_debug.yaml` в папке с приложением и проверьте:

**DNS секция (КРИТИЧНО):**
```yaml
dns:
  enable: true
  prefer-h3: true       # ← ОБЯЗАТЕЛЬНО
  default-nameserver:   # ← ОБЯЗАТЕЛЬНО
    - 8.8.8.8
    - 1.1.1.1
  nameserver:           # ← ОБЯЗАТЕЛЬНО (DoH)
    - https://dns.google/dns-query
    - https://1.1.1.1/dns-query
  fallback:             # ← ОБЯЗАТЕЛЬНО (DoT)
    - tls://9.9.9.9
    - tls://8.8.4.4
```

**TUN секция (КРИТИЧНО):**
```yaml
tun:
  enable: true
  stack: gvisor         # ← ОБЯЗАТЕЛЬНО (не system!)
  auto-route: true
  auto-detect-interface: true
  dns-hijack:
    - "198.18.0.2:53"   # ← ОБЯЗАТЕЛЬНО (правильный адрес)
  mtu: 9000             # ← ОБЯЗАТЕЛЬНО
```

**Proxy секция:**
```yaml
proxies:
  - name: "VLF-troynichek-live.ru"  # ← Имя зависит от сервера
```

**Proxy-groups секция:**
```yaml
proxy-groups:
  - name: "VLF"
    proxies:
      - "VLF-troynichek-live.ru"  # ← Должно совпадать с proxies
```

**Rules секция (MATCH использует VLF):**
```yaml
rules:
  # ... другие правила ...
  - MATCH,VLF  # ← Должно совпадать с proxy-groups
```

## Технические детали

### Файлы изменены

1. **lib/clash_config.dart**
   - Убран fake-ip режим (не работает в Windows TUN)
   - Добавлены DoH/DoT серверы (dns.google, 1.1.1.1, 9.9.9.9)
   - Изменен TUN stack на gvisor (единственный стабильный для Windows)
   - Исправлен dns-hijack на правильный адрес (198.18.0.2:53)
   - Добавлен MTU 9000
   - Автоматическая генерация имени прокси (VLF-$server)
   - MATCH теперь использует правильное имя группы "VLF"

2. **lib/core/vlf_core.dart**
   - Удалены упоминания singbox (миграция завершена)
   - Переименован singboxManager → clashManager

3. **lib/ui/widgets/log_panel.dart**
   - Логи не очищаются автоматически при рестарте
   - История сохраняется между переключениями режимов

### Почему это работает

**Проблема stack: system:**
- Windows TUN драйвер (wintun.dll) нестабилен с system stack
- Пакеты теряются или неправильно маршрутизируются
- DNS не резолвится корректно

**Решение:**
- `stack: gvisor` — это user-space TCP/IP stack
- Работает стабильно в Windows без конфликтов с wintun
- Правильно обрабатывает DNS и маршрутизацию

**Проблема DNS:**
- fake-ip создает виртуальные IP и конфликтует с Windows DNS
- Некоторые приложения (банки, браузеры) не работают с fake-ip

**Решение:**
- Используем реальные DNS через DoH/DoT
- Безопасно (шифрование) и совместимо со всеми приложениями
- prefer-h3 ускоряет DNS запросы через HTTP/3

**Проблема dns-hijack:**
- `any:53` перехватывает слишком много (включая локальные DNS)
- Конфликтует с Windows DNS сервисом

**Решение:**
- `198.18.0.2:53` — специальный адрес для gvisor stack
- Перехватывает только DNS через TUN интерфейс
- Не конфликтует с системными DNS

## Известные ограничения

1. **Первый запуск требует прав администратора:** wintun.dll требует повышенных прав для создания TUN интерфейса.
2. **MTU 9000 может быть велико для некоторых сетей:** если возникают проблемы с загрузкой больших файлов, попробуйте уменьшить MTU до 1500.
3. **HTTP/3 (QUIC) может работать нестабильно:** gvisor stack иногда медленнее обрабатывает UDP трафик. Это нормально.

## Что делать, если всё ещё не работает

### 1. Проверьте права администратора

TUN-режим требует прав администратора. Убедитесь, что приложение запущено от имени администратора.

### 2. Проверьте mihomo.exe версию

Используйте mihomo.exe версии >= 1.18.0 (Clash Meta). Старые версии могут не поддерживать dns-hijack и strict-route.

### 3. Проверьте логи

Откройте вкладку "Логи" и найдите строки:
```
[INFO] TUN mode enabled
[INFO] DNS server listening at 0.0.0.0:1053
[INFO] RESTful API listening at 127.0.0.1:9090
```

Если их нет — TUN не запустился (проблема с правами или wintun.dll).

### 4. Проверьте config_debug.yaml

Убедитесь, что:
- `stack: gvisor` (НЕ system!)
- `dns-hijack: ["198.18.0.2:53"]` (НЕ any:53!)
- `mtu: 9000` присутствует
- DoH серверы (https://dns.google/dns-query) присутствуют

### 5. Перезагрузите компьютер

После первой установки wintun.dll может потребоваться перезагрузка для корректной работы TUN-драйвера.

## Changelog

### 26.11.2025 - КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ
- ✅ **TUN stack изменен на gvisor** (было: system) — единственный стабильный для Windows
- ✅ **DNS режим изменен с fake-ip на DoH/DoT** — убраны конфликты с Windows
- ✅ **dns-hijack исправлен на 198.18.0.2:53** (было: any:53) — правильный адрес для gvisor
- ✅ **Добавлен MTU 9000** — оптимальная производительность
- ✅ **Автоматическое имя proxy в MATCH** — нет хардкода, всегда корректное имя
- ✅ **Удалены все упоминания sing-box** — миграция на Clash завершена
- ✅ Логи сохраняются между переключениями режимов

### 25.11.2025
- ✅ Первичная миграция на Clash Meta (mihomo)
- ✅ Базовая конфигурация TUN + DNS

## Для разработчиков

### Тестирование изменений

```bash
dart run test_rules_priority.dart
```

Должны пройти все 5 тестов:
- ТЕСТ 1: Режим РФ БЕЗ исключений
- ТЕСТ 2: Режим РФ С исключениями
- ТЕСТ 3: Глобальный режим С исключениями
- ТЕСТ 4: Проверка DNS fake-ip-filter
- ТЕСТ 5: Проверка TUN конфигурации

### Сборка релиза

```powershell
pwsh .\tools\build_and_package.ps1 -ProjectRoot (Get-Location).Path
```

Релиз будет в `release\windows_x64_release\VLF_VPN.exe`

---

**Статус:** ✅ ИНТЕРНЕТ РАБОТАЕТ  
**Версия:** 26.11.2025  
**Критичность:** ВЫСОКАЯ — без этих исправлений интернет НЕ работает  
**Тестирование:** Проверено на Windows 10/11 x64
