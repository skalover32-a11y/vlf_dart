# Критическое исправление: РФ-режим и исключения теперь работают

## Дата: 25 ноября 2025

## Проблема

После миграции на Clash Meta (mihomo) обнаружились критические проблемы:

1. **РФ-режим не работал**: российские сайты (.ru/.su/.рф, включая 2ip.ru, vk.com, yandex.ru) продолжали идти через VPN вместо DIRECT
2. **Исключения не работали**: домены и приложения, добавленные в исключения, игнорировались
3. **Логи очищались** при остановке/перезапуске туннеля

**Причина:** Конфликт DNS fake-ip режима с DIRECT-маршрутизацией + недостаточно агрессивный перехват трафика в TUN.

## Решение

### 1. Исправлен DNS (fake-ip-filter)

**Проблема:** Российские домены попадали в fake-ip пул и резолвились через прокси-DNS, игнорируя DIRECT правила.

**Решение:**
```yaml
dns:
  enhanced-mode: fake-ip
  fake-ip-filter:
    - "*.lan"
    - "localhost.ptlogin2.qq.com"
    # НОВОЕ: исключаем российские домены из fake-ip в РФ-режиме
    - "+.ru"
    - "+.su"
    - "+.рф"
  
  # НОВОЕ: используем российские DNS для .ru/.su/.рф
  nameserver-policy:
    "+.ru": ["77.88.8.8", "77.88.8.1"]  # Yandex DNS
    "+.su": ["77.88.8.8", "77.88.8.1"]
    "+.рф": ["77.88.8.8", "77.88.8.1"]
```

**Эффект:** Российские домены теперь резолвятся через реальные российские DNS (Yandex) и корректно маршрутизируются через DIRECT.

### 2. Усилен TUN-перехват трафика

**Проблема:** Некоторый трафик обходил TUN-интерфейс и правила маршрутизации.

**Решение:**
```yaml
tun:
  enable: true
  stack: system
  auto-route: true
  auto-detect-interface: true
  # НОВОЕ: агрессивный перехват DNS
  dns-hijack:
    - any:53
    - tcp://any:53
  # НОВОЕ: строгая маршрутизация
  strict-route: true
```

**Эффект:**
- `dns-hijack` перехватывает **все** DNS-запросы (UDP и TCP на порт 53)
- `strict-route: true` обеспечивает строгое следование правилам маршрутизации

### 3. Сохранение истории логов

**Проблема:** Логи очищались при остановке туннеля.

**Решение:**
- Логи теперь хранятся на уровне виджета UI (не зависят от Logger в ClashManager)
- Добавлена кнопка "Очистить" для ручной очистки логов
- История логов сохраняется между перезапусками туннеля

## Как проверить, что теперь работает

### Проверка РФ-режима

1. **Включите РФ-режим** (переключатель "Режим РФ")
2. **Запустите VPN**
3. **Откройте https://2ip.ru** → должен показать ваш **реальный российский IP** (ISP IP, не IP VPN-сервера)
4. **Откройте https://google.com** → должен показать **IP VPN-сервера** (другая страна)

### Проверка исключений

1. **Добавьте google.com в исключения** (Настройки → Исключения → Добавить домен)
2. **Запустите VPN** (режим не важен)
3. **Откройте https://google.com** → должен показать ваш **реальный IP** (не IP VPN)
4. **Откройте https://youtube.com** → должен показать **IP VPN-сервера**

### Проверка конфигурации

Откройте `config_debug.yaml` в папке с приложением и проверьте:

**DNS секция:**
```yaml
dns:
  fake-ip-filter:
    - "*.lan"
    - "localhost.ptlogin2.qq.com"
    - "+.ru"      # ← Должно быть в РФ-режиме
    - "+.su"      # ← Должно быть в РФ-режиме
    - "+.рф"      # ← Должно быть в РФ-режиме
  nameserver-policy:
    "+.ru": ["77.88.8.8", "77.88.8.1"]  # ← Должно быть в РФ-режиме
```

**TUN секция:**
```yaml
tun:
  dns-hijack:      # ← ОБЯЗАТЕЛЬНО
    - any:53
    - tcp://any:53
  strict-route: true  # ← ОБЯЗАТЕЛЬНО
```

**Rules секция (порядок критичен!):**
```yaml
rules:
  # 1. ИСКЛЮЧЕНИЯ (если есть) — ВЫСШИЙ ПРИОРИТЕТ
  - PROCESS-NAME,chrome.exe,DIRECT
  - DOMAIN-SUFFIX,google.com,DIRECT
  
  # 2. ЛОКАЛЬНЫЕ СЕТИ
  - GEOIP,private,DIRECT,no-resolve
  
  # 3. РФ-РЕЖИМ (если включен)
  - DOMAIN-SUFFIX,ru,DIRECT
  - DOMAIN-SUFFIX,su,DIRECT
  - DOMAIN-SUFFIX,рф,DIRECT
  - GEOIP,RU,DIRECT,no-resolve
  - DOMAIN-SUFFIX,2ip.ru,DIRECT
  
  # 4. ВСЁ ОСТАЛЬНОЕ
  - MATCH,VLF
```

## Технические детали

### Файлы изменены

1. **lib/clash_config.dart**
   - Добавлен fake-ip-filter для .ru/.su/.рф в РФ-режиме
   - Изменены nameserver-policy на прямые IP российских DNS (77.88.8.8)
   - Добавлены dns-hijack и strict-route в TUN

2. **lib/ui/widgets/log_panel.dart**
   - Логи теперь сохраняются на уровне виджета
   - Добавлена кнопка "Очистить" для ручной очистки

3. **test_rules_priority.dart**
   - Добавлены тесты DNS (ТЕСТ 4)
   - Добавлены тесты TUN (ТЕСТ 5)

### Почему это работает

**Проблема fake-ip:**
- Clash fake-ip создаёт виртуальные IP (198.18.x.x) для доменов
- Если домен попадает в fake-ip, он резолвится через прокси-DNS
- DOMAIN-SUFFIX правила проверяются **после** резолвинга
- Результат: .ru домены получали fake-ip и игнорировали DIRECT правила

**Решение:**
- fake-ip-filter исключает .ru/.su/.рф из fake-ip пула
- nameserver-policy отправляет их на российские DNS
- Теперь .ru домены резолвятся РЕАЛЬНО и попадают в DIRECT правила

**Проблема TUN:**
- Без dns-hijack некоторые приложения могут использовать свои DNS (8.8.8.8, 1.1.1.1)
- Без strict-route система может выбирать альтернативные маршруты

**Решение:**
- dns-hijack перехватывает ALL DNS на порт 53
- strict-route запрещает обход правил маршрутизации

## Известные ограничения

1. **Первый запрос может пройти через VPN:** mihomo кэширует DNS на 5-10 секунд. При первом запросе к .ru домену может быть задержка.
2. **HTTP/3 (QUIC) может обходить правила:** некоторые сайты (Google, Cloudflare) используют QUIC over UDP/443. Добавьте их в исключения, если нужно.
3. **Chrome DoH:** если в Chrome включен DoH (DNS-over-HTTPS), он может обходить dns-hijack. Отключите DoH в настройках Chrome.

## Что делать, если всё ещё не работает

### 1. Проверьте права администратора

TUN-режим требует прав администратора. Убедитесь, что приложение запущено от имени администратора.

### 2. Проверьте mihomo.exe версию

Используйте mihomo.exe версии >= 1.18.0 (Clash Meta). Старые версии могут не поддерживать dns-hijack и strict-route.

### 3. Проверьте логи

Откройте вкладку "Логи" и найдите строки:
```
[INFO] TUN mode enabled
[INFO] DNS server listening at 0.0.0.0:1053
[INFO] RESTful API listening at 127.0.0.1:9090
```

Если их нет — TUN не запустился (проблема с правами или wintun.dll).

### 4. Проверьте config_debug.yaml

Убедитесь, что:
- fake-ip-filter содержит +.ru/+.su/+.рф (в РФ-режиме)
- dns-hijack присутствует в tun секции
- strict-route: true установлен

### 5. Перезагрузите компьютер

После первой установки wintun.dll может потребоваться перезагрузка для корректной работы TUN-драйвера.

## Changelog

- ✅ DNS fake-ip-filter теперь исключает российские домены в РФ-режиме
- ✅ DNS nameserver-policy использует российские DNS (Yandex) для .ru/.su/.рф
- ✅ TUN dns-hijack перехватывает все DNS-запросы
- ✅ TUN strict-route обеспечивает строгую маршрутизацию
- ✅ Логи сохраняются между перезапусками туннеля
- ✅ Добавлена кнопка "Очистить" для ручной очистки логов
- ✅ Добавлены тесты DNS и TUN конфигурации

## Для разработчиков

### Тестирование изменений

```bash
dart run test_rules_priority.dart
```

Должны пройти все 5 тестов:
- ТЕСТ 1: Режим РФ БЕЗ исключений
- ТЕСТ 2: Режим РФ С исключениями
- ТЕСТ 3: Глобальный режим С исключениями
- ТЕСТ 4: Проверка DNS fake-ip-filter
- ТЕСТ 5: Проверка TUN конфигурации

### Сборка релиза

```powershell
pwsh .\tools\build_and_package.ps1 -ProjectRoot (Get-Location).Path
```

Релиз будет в `release\windows_x64_release\VLF_VPN.exe`

---

**Статус:** ✅ КРИТИЧЕСКИЕ ПРОБЛЕМЫ ИСПРАВЛЕНЫ  
**Версия:** 25.11.2025  
**Тестирование:** Все тесты пройдены
